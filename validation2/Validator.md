# Validators

Механизм валидаторов, позволяет на основе метаданных собрать методы для проверки корректности предоставленных данных.

## Метод проверки имеет следующий вид:

*function(context?, value, message?, validateOptions) { ... }*, где 

* *context*? - это метод, который при вызове возвращает строку о положении проверяемого элемента в общей структуре

* *value* - значение, которое проверяется валидатором

* *message*? - массив текстовых сообщения о найденных проблемах

* *validateOptions* - методы выдачи сообщений об ошибках

Метод возвращает, обновленное значение message, если были найдены проблемы, или undefined если претензий у данного валидатора не возникло

## VType

Чтобы описывать типы данных, есть расширение VType, позволяющее записывать данные в функциональном виде.  Например:

* *VType.String()*

* *VType.String(v => v.length > 0 ? true : 'не пустая строка')*

Так же есть вариант использования субвалидторов (правила, который добаляют дополнительные провеки к валидатору через 'или').  Например:

* *VType.String().notEmpty()*

* *VType.Int().zero().positive()*

Перечень типов VType и их субвалидаторов можно увидеть в файле src/common/validation/typesBuiltIn.js

Можно добавлять свой типы и субвалидаторы непосредственно в своем проекте

## Билдеры валидаторов

Метаданные для построения валидаторов обрабатывают билдерами, которые уже возвращают сами валидаторы.  Метод билдера
имеет следующий вид: function (context, fieldDef) { ... }, где

* *context* - это метод, который при вызове возвращает строкуо положении проверяемого элемента в общей структуре метаданных по валидации

* *fieldDef* - описание поля

При этом этот метод для специальных случаев может иметь дополнительные или вообще другие параметры.  Например:

* *function _validateType(context, fieldDef, type) ...*

* *function _validateSubfields(parentContext, fields) ...*

* *function _validateArray(context, itemType) ...*

**Для чего нужны билдеры:**

* Для проверки корректности предоставленных метаданных

* Как closure, для метода валидатора, в котором хранятся правила валидации взятые из метаданных  

## Методанные структуры

* *_extends: ...* - данная структура наследует описание предыдущей структуру.  При этом родительская структура не может быть _final: true

* *_final: true/false* - является ли данная структура завершенной.  Если да, то для ней будут выводиться сообщения unexpectedField (см. ниже) 

* *_validate: ...* - метод комплексной проверки структуры, позволяющий соблюдать правила включающие несколько полей.  Вид метода *function(context?, value, message?, validateOptions)*
  
## Контекст

Валидаторы могут использоваться для разных целей и в разных контекстах.  Например: 

* для проверки опций конструктора

* проверки параметров функций

* проверки структуры событий

* в тестах

Так что важно, через validationOptions уметь передавать разные реализации методов:

* *missingField(context)* - сообщение о том, что отсутствует обязательное поле

* *invalidFieldValue(context, value)* - сообщение о том, что поле содержит недопустимое значение

* *unexpectedField(context, value[fieldName])* - сообщение о том, что поля с таким именем не ожидали

* *onMessage(message)* - что делать, если были найден проблемы

## Оптимизация

При таком количестве проверок, желательно повторно использовать одни и те же методы проверки, если они проверяют то же самое условие.

Чтобы это достигнуть, валидаторы, по возможности, не должны включать в себя:
 
* информацию о контексте в котором они работают

* методы, используемые для формирования сообщений об ошибках

И должны содержать свойство _key, которое является строковым ключом, описывающим все основные детали проверки, которые выполняет данные валидатор 

*Билдеры*

Получается что мы хотим подвторно использовать валидаторы которые проверяют одно и то же правило.  При этом, сам валидатор определяется его билдером, 
так как в билдере, как в closure, могут хранится данные влияющие на поведение валидатора.

В идеале, каждый билдер должне для одного и того же окружения возвращать один и тот же валидатор.  При этом, если он внутри использует вложенные валидаторы, 
чтобы определить что они одни и те же, он должен вместе с валидаторами, получать строковое представление - _key.
